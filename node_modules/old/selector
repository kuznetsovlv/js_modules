#!/usr/bin/env node

"use strict"

var countrys = Object.defineProperties({}, {
	/*Data:*/
	4070: {value: 'Finland', writeble: false, enumerable: true, configurable: false},
	/*Methods*/
	getCode: {
		value: function (country) {
			if (typeof country !== 'string')
				return undefined;
			country = country.toLowerCase();
			for (var code in this)
				if (this[code].toLowerCase() === country)
					return code;
			return undefined;
		},
		writeble: false,
		enumerable: false,
		configurable: false
	},
	checkValue: {
		value: function (code, value) {
			return this[code] && code === value;
		},
		writeble: false,
		enumerable: false,
		configurable: false
	}
});
var causes = Object.defineProperties({},{
	/*Data:*/
	all: {
		value: {
			name: "All causes",
			regExps: {
				'07A': /^A000$/,
				'07B': /^B000$/,
				'08A': /^A000$/,
				'08B': /^B000$/,
				'09A': /^B00$/,
				'09B': /^B00$/,
				'101': /^1000$/,
				'104': /^AAA$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	I: {
		value: {
			name: "Infective and parasitic diseases",
			regExps: {
				'07A': /^A0(?:(?:0[1-9])|(?:[1-3]\d)|(?:4[0-3]))$/,
				'07B': /^B0(?:0[1-9])|(?:1[0-7])$/,
				'08A': /^A0(?:(?:0[1-9])|(?:[1-3]\d)|(?:4[0-4]))$/,
				'08B': /^B0(?:0[1-9])|(?:1[0-8])$/,
				'09A': /^B0[1-7]$/,
				'09B': /^B0[1-7]$/,
				'101': /^1001$/,
				'104': /^[AB]\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	II: {
		value: {
			name: "Neoplasms",
			regExps: {
				'07A': /^A0(?:(?:4[4-9])|(?:5\d)|(?:60))$/,
				'07B': /^B01[89]$/,
				'08A': /^A0(?:(?:4[5-9])|(?:5\d)|(?:6[01]))$/,
				'08B': /^B0(?:(?:19)|(?:20))$/,
				'09A': /^B(?:(?:0[89])|(?:1[0-7]))\d$/,
				'09B': /^B(?:(?:0[89])|(?:1[0-7]))\d$/,
				'101': /^1026$/,
				'104': /^(?:(?:C\d{2,3})|(?:D(?:(?:[0-3]\d\d?)|(?:4[0-8]\d?))))$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	III: {
		value: {
			name: "Endocrine and metabolic diseases",
			regExps: {
				'07A': /^A06[1-4]$/,
				'07B': /^B020$/,
				'08A': /^A06[2-6]$/,
				'08B': /^B02[12]$/,
				'09A': /^B1[89]$/,
				'09B': /^B1[89]$/,
				'101': /^1051$/,
				'104': /^E(?:(?:[0-7]\d)|(?:8[0-8]))\d?$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	IV: {
		value: {
			name: "Diseases of blood and blood-forming organs",
			regExps: {
				'07A': /^A06[56]$/,
				'07B': /^B021$/,
				'08A': /^A06[78]$/,
				'08B': /^B023$/,
				'09A': /^B20$/,
				'09B': /^B20$/,
				'101': /^1048$/,
				'104': /^D[5-7]\d\d?$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	V: {
		value: {
			name: "Mental and behavioural disorders",
			regExps: {
				'07A': /^A06[7-9]$/,
				'07B': /^$B045/,
				'08A': /^A0(?:(?:69)|(?:7[01]))$/,
				'08B': /^$/,
				'09A': /^B21$/,
				'09B': /^B21$/,
				'101': /^1055$/,
				'104': /^F\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	VI: {
		value: {
			name: "Diseases of the nervous system and sense organs",
			regExps: {
				'07A': /^A07[0-8]$/,
				'07B': /^B02[23]$/,
				'08A': /^A07[2-9]$/,
				'08B': /^B024$/,
				'09A': /^B2[2-4]$/,
				'09B': /^B2[2-4]$/,
				'101': /^10(?:(?:58)|(?:6[23]))$/,
				'104': /^[GH]\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	VII: {
		value: {
			name: "Disorders of circulatory system",
			regExps: {
				'07A': /^A0(?:79)|(?:8[0-6])$/,
				'07B': /^B02[4-9]$/,
				'08A': /^A08[0-8]$/,
				'08B': /^B0(?:(?:2[5-9])|(?:30))$/,
				'09A': /^B(?:(?:2[5-9])|(?:30))$/,
				'09B': /^B(?:(?:2[5-9])|(?:30))$/,
				'101': /^1064$/,
				'104': /^I\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	VII_Isch: {
		value: {
			name: "Ischaemic heart diseases",
			regExps: {
				'07A': /^A081$/,
				'07B': /^B026$/,
				'08A': /^A083$/,
				'08B': /^B028$/,
				'09A': /^B27$/,
				'09B': /^B27$/,
				'101': /^1067$/,
				'104': /^I2[0-5]\d$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	VIII: {
		value: {
			name: "Diseases of the respiratory system",
			regExps: {
				'07A': /^A0(?:(?:8[7-9])|(?:9[0-7]))$/,
				'07B': /^B03[0-2]$/,
				'08A': /^A0(?:(?:89)|(?:9[0-6]))$/,
				'08B': /^B03[1-3]$/,
				'09A': /^B3[12]$/,
				'09B': /^B3[12]$/,
				'101': /^1072$/,
				'104': /^J\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	IX: {
		value: {
			name: "Diseases of the digestive system",
			regExps: {
				'07A': /^A(?:(?:09[7-9])|(?:10[0-7]))$/,
				'07B': /^B03[3-7]$/,
				'08A': /^A(?:(?:09[7-9])|(?:10[0-4]))$/,
				'08B': /^B03[4-7]$/,
				'09A': /^B3[34]$/,
				'09B': /^B3[34]$/,
				'101': /^1078$/,
				'104': /^K\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	X: {
		value: {
			name: "Diseases of genito-urinary system",
			regExps: {
				'07A': /^A1(?:(?:0[89])|(?:1[0-4]))$/,
				'07B': /^B03[89]$/,
				'08A': /^A1(?:(?:0[5-9])|(?:1[01]))$/,
				'08B': /^B03[89]$/,
				'09A': /^B3[5-7]$/,
				'09B': /^B3[5-7]$/,
				'101': /^1084$/,
				'104': /^N\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	XI: {
		value: {
			name: "Diseases of the skin and subcutaneous tissue and musculoskeletal system",
			regExps: {
				'07A': /^A12[1-6]$/,
				'07B': /^$/,
				'08A': /^A1(?:(?:19)|(?:2[0-5]))$/,
				'08B': /^$/,
				'09A': /^B4[23]$/,
				'09B': /^B4[23]$/,
				'101': /^108[23]$/,
				'104': /^[LM]\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	XII: {
		value: {
			name: "Pregnancy and childbirth and the puerperium",
			regExps: {
				'07A': /^A1(?:(?:1[5-9])|(?:20))$/,
				'07B': /^B040$/,
				'08A': /^A11[2-8]$/,
				'08B': /^B04[01]$/,
				'09A': /^B(?:(?:3[89])|(?:4[01]))$/,
				'09B': /^B(?:(?:3[89])|(?:4[01]))$/,
				'101': /^1087$/,
				'104': /^O\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	XIII: {
		value: {
			name: "Certain conditions originating in the perinatal period",
			regExps: {
				'07A': /^A13[0-5]$/,
				'07B': /^B04[2-4]$/,
				'08A': /^A13[1-5]$/,
				'08B': /^B04[34]$/,
				'09A': /^B45$/,
				'09B': /^B45$/,
				'101': /^1092$/,
				'104': /^P\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	XIV: {
		value: {
			name: "Congenital malformations and deformations and chromosomal abnormalities",
			regExps: {
				'07A': /^A12[7-9]$/,
				'07B': /^B041$/,
				'08A': /^A1(?:(?:2[6-9])|(?:30))$/,
				'08B': /^B042$/,
				'09A': /^B44$/,
				'09B': /^B44$/,
				'101': /^1093$/,
				'104': /^Q\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	XV: {
		value: {
			name: "External causes of morbidity and mortality",
			regExps: {
				'07A': /^A1(?:(?:3[89])|(?:4\d)|(?:50))$/,
				'07B': /^B0(?:(?:4[7-9])|(?:50))$/,
				'08A': /^A1(?:(?:3[89])|(?:4\d)|(?:50))$/,
				'08B': /^B0(?:(?:4[7-9])|(?:50))$/,
				'09A': /^B(?:(?:4[7-9])|(?:5[0-6]))$/,
				'09B': /^B(?:(?:4[7-9])|(?:5[0-6]))$/,
				'101': /^1095$/,
				'104': /^[V-Y]\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	XVI: {
		value: {
			name: "Other",
			regExps: {
				'07A': /^A13[67]$/,
				'07B': /^B04[56]$/,
				'08A': /^A13[67]$/,
				'08B': /^B04[56]$/,
				'09A': /^B46$/,
				'09B': /^B46$/,
				'101': /^1094$/,
				'104': /^R\d{2,3}$/
			}
		},
		writeble: false,
		enumerable: true,
		configurable: false
	},
	/*Methods:*/
	getCode: {
		value: function (name) {
			if (typeof name !== 'string')
				return undefined;
			name = name.toLowerCase();
			for (var code in this)
				if (this[code].name.toLowerCase() === name)
					return code;
			return undefined;
		},
		writeble: false,
		enumerable: false,
		configurable: false
	},
	checkValue: {
		value: function (code, icd, value) {
			var r = this[code];
			if (!r)
				return undefined;
			r = r.regExps[icd];
			if (!r)
				return undefined;
			switch (typeof value) {
				case 'number': value = [value, ''].join(''); 
				case 'string': return r.test(value); break;
				default: return undefined;
			}
		},
		writeble: false,
		enumerable: false,
		configurable: false
	},
	getCauseName:  {
		value: function (code) {
			if (code in this)
				return this[code].name;
			return undefined;
		},
		writeble: false,
		enumerable: false,
		configurable: false
	}
});

function Selector (selectors, opts) {
	var del = opts.del || ',',
	    keys = opts.keys,
	    checkers = {
	    	defaultCheck: function () {return true;}
	    };
	if (selectors.country) {
		var code = selectors.country;
		if (!countrys[c])
			code = countrys.getCode(c);
		checkers.country = function (value) {
			return countrys.checkValue(code, value);
		}
	}
	if (selectors.cause) {
		code = selectors.cause;
		if (!causes[code])
			code = causes.getCode(code);
		checkers.cause = function (value, icd) {
			return causes.checkValue(code, icd, value);
		}
	}
	if (selectors.sex) {
		var sexes = ['none', 'male', 'female'],
		    sex = selectors.sex;
		if (typeof sex !== 'number') {
			if (sexes[+sex]) {
				sex = +sex;
			} else {
				sex = sex.toLowerCase();
				for (var s = 0, l = sexes.length; s < l; ++s)
					if (sex === sexes[s]) {
						sex = s;
						break;
					}
			}
		}
		checkers.sex = function (value) {
			return +value === sex;
		}
	}
	if (selectors.year) {
		var year = selectors.year,
		    min = 0, max = 0;
		if (/^\d{4}-\d{4}$/.test(year)) {
			year = year.split('-');
			min = +year[0];
			max = +year[1];
		} else if (/^\d{4}[-+]$/.test(year)) {
			min = + year.slice(0, -1);
			max = Infinity;
		} else {
			min = max = +year;
		}
		checkers.year = function (value) {
			value = +value;
			return value >= min && value <= max;
		}
	}
	if (typeof keys === 'string')
		keys = keys.toLowerCase().split(del);
	else
		for (var i = 0, l = keys.length; i < l; ++i)
			keys[i] = keys[i].toLowerCase();
	this.checkString = function checkString (str) {
		if (typeof str === 'string')
			str = str.split(del);
		function _getValue (key) {
			for (var i = 0, l = keys.length; i < l; ++i)
				if (keys[i] === key)
					return str[i];
			return undefined;
		}
		var icd = _getValue('list');
		for (var key in checkers) {
			if (!checkers[key](_getValue(key), icd))
				return false;
		}
		return true;
	}
	this.checkValues = function checkValues (values) {
		//console.log(checkers, value);
		for (var key in checkers) {
			if (!checkers[key](values[key], values.list))
				return false;
		}
		return true;
	}
	this.getCauseName = function getCauseName (code) {
		return causes.getCauseName(code);
	}
}

exports.getSelector = function (selectors, opts) {return new Selector (selectors, opts)};
